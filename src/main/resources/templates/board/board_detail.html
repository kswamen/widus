<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorator="common/layout/basic">

/* 좋아요 테이블을 만들 때 좋아요를 누른 인원에 대해 스트링 형태로 전달한 후 나중에 리스트로 파싱 */

<th:block layout:fragment="content">
	<div class="container-div">
		<input id="userEmailInput" type="hidden" th:if="${user != null}" th:value="${user.email}">
		<input id="userEmailInput" type="hidden" th:unless="${user != null}" value="null">
		
		<div class="card main-div title-div">
			<div class="card-body">
				[[${board.getTitle()}]]
			</div>
		</div>
		<div>
			<div class="main-div info-div">
				<p>[[${#temporals.format(board.getCreateDate(), "yyyy-MM-dd HH:mm")}]]</p>
				<p>조회수: [[${board.getVisit()}]]</p>
			</div>
		</div>
		<div class="main-div content-div">
			<div class="content-innerHTML">
				/* fill on window.onload.. */
			</div>
		</div>
		<div class="main-div control-div">
			<div class="wrote-user-info">
				<img style="border-radius: 50%; width: 50px;" th:src="${wroteUser.getPicture()}" />
				[[${wroteUser.getName()}]]
			</div>
			<div th:if="${user != null && (user.getEmail() == wroteUser.getEmail())}" class="button-div">
				<a th:href="@{/board/board_write.do(id=${boardId})}"><button type="button" class="btn btn-primary">수정</button></a>
				<a th:href="@{/board/board_delete.do(id=${boardId})}"><button type="button" class="btn btn-danger">삭제</button></a>
			</div>
			<div th:unless="${user != null && (user.getEmail() == wroteUser.getEmail())}" style="width: 120px;">
			</div>
		</div>
		<div class="main-div recommend-div">
			<button type="button" class="btn btn-secondary">추천하기 👍 <br> [[${board.getRecommend()}]]</button>
		</div>
		<div class="main-div comment-write-div">
			<div class="comment-not-login" th:if="${user == null}">
				댓글을 남기려면 로그인해야 합니다.
			</div>
			<div class="input-group mb-3 comment-write" th:unless="${user == null}">
			  <img class="user_profile_image" th:src="${user.getPicture()}" />
			  <input type="text" class="form-control comment-input" placeholder="댓글을 입력하세요" aria-label="Recipient's username" aria-describedby="button-addon2">
			  <div class="input-group-append">
			    <button class="btn btn-outline-secondary" type="button" id="button-addon2">작성</button>
			  </div>
			</div>
		</div>
		<div class="main-div comments-list-div">
			
			<!--
				<div class="collapse" id = "collapseExample">
					<div class="nested-comment-div">
						<div class="comment-header">
							<img style="border-radius: 50%;" src="https://placeimg.com/50/50/any/grayscale" />
						</div>
						<div class="comment-content">
							 <div class="badge badge-secondary badge-pill text-wrap" style="width: 6rem;">
								  유저 이름
							 </div>
							 <input type="text" class="form-control comment-show" readonly aria-label="Username" value="asdf">
						</div>
						<div class="comment-control-btn">
							<button type="button" class="btn btn-outline-primary">수정</button>
							<button type="button" class="btn btn-outline-danger">삭제</button>
						</div>
					</div>
				</div>
			-->
		</div>
	</div>
</th:block>

<th:block layout:fragment="script">
	<script th:src="@{/scripts/common.js}"></script>
	<script th:inline="javascript">
		/*<![CDATA[*/

		$(document).ready(function () {
			var innerHTML = /*[[${board.getContent()}]]*/ null;
			$("div.content-innerHTML").html(innerHTML);
			
			printCommentList();
		});
	
		function printCommentList() {
	
			var uri = /*[[ @{/comment/list.do?boardId=} + ${board.getId()} ]]*/ null;
	
			$.get(uri, function(response) {
				console.log(response)
				if (isEmpty(response) == false) {
					var commentsHtml = "";
					var isLoggedIn = /*[[${user != null}]]*/ null;
					var userEmail = $("input#userEmailInput").val();
					
					$(response).each(function(idx, comment) {
						commentsHtml += `
						<div class="comment-div">
							<div class="comment-header">
								<img style="border-radius: 50%;" src="${comment.picture}" />
							</div>
							<div class="comment-content">
								 <div class="badge badge-secondary badge-pill text-wrap" style="width: 6rem;">
									  ${comment.writer}
								 </div>
								 <input type="text" class="form-control comment-show" readonly aria-label="Username" value="${comment.content}">
								 <div class="div-open-comment">`;
						if (isLoggedIn) {
							commentsHtml += `<button type="button" class="btn btn-outline-info btn-nested-comment">댓글</button>`;
						}
						commentsHtml += `
								 	<button class="btn btn-outline-secondary" type="button" data-toggle="collapse" data-target="#collapseExample" aria-expanded="false" aria-controls="collapseExample">
								    	댓글창 토글
								 	</button>
								 </div>
							</div>
							<div class="comment-control-btn">`;
						console.log(userEmail, comment.email);
						if (userEmail == comment.email) {
							commentsHtml += `
								<button type="button" class="btn btn-outline-primary">수정</button>
								<button type="button" class="btn btn-outline-danger">삭제</button>`;
						}
						commentsHtml += `
							</div>
						</div>
						`;
					});
					
					$("div.comments-list-div").html(commentsHtml);
				}
			}, "json");
		}

		/*[- end of function -]*/
		/*]]>*/
	</script>

</th:block>

<th:block layout:fragment="css">
	<link rel="stylesheet" th:href="@{/css/board_detail.css}" />
</th:block>

</html>